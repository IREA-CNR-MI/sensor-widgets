define(["SOS","jquery","jquery-ui","daterangepicker","css!widget/builder.css","css!../../css/daterangepicker.css"],function(e,t){function r(e,r,p){var d="<h1>"+c(r.name)+" Widget<br/><small>Builder</small></h1>";for(var l in e.inputs){var f=e.inputs[l],m="",v=c(f);switch(f){case"service":case"offering":case"feature":case"property":m='<select id="'+f+'"></select>';break;case"features":case"properties":m='<select multiple id="'+f+'"></select>',v+=" (multiselect)";break;case"refresh_interval":var g="",h=[5,10,30,60,120];for(l in h){var b=h[l];g+='<option id="'+b+'">'+b+"</option>"}m='<select id="'+f+'">'+g+"</select>";break;case"time_start":t.inArray("time_end",e.inputs)&&(v="Time Range",m='<span id="time_range"><span class="sublabel">From: </span><input type="text" id="time_start" value=""/><br/>',m+='<span class="sublabel">To: </span><input type="text" id="time_end" value=""/></span>');break;case"time_end":break;default:m='<input type="text" value="" id="'+f+'"/>'}m&&(d+='<div class="select"><label for="'+f+'">'+v+":</label>"+m+"</div>")}d+='<button name="build">Create Widget</button>',p.innerHTML='<div id="editor">'+d+'</div><div id="preview"><h1 id="header"><img src="../../img/logo.svg"/>Widget<br/><small>Preview</small></h1><div id="widget"></div></div>',t("#widget").resizable({helper:"ui-resizable-helper"}),t("#widget").draggable({opacity:.35}),t('[name="build"]').data({name:r.name,inputs:e.inputs}).click(u),a(["http://sensors.portdebarcelona.cat/sos/json","/52n-sos/sos/json","http://metagato.fonts.cat/52n-sos/sos/json"]),t("#service").change(function(){var e=t("#service option:selected").attr("id");i(e),s()}),t("#offering").change(function(){var e=t("#offering option:selected").data("procedure");o(e),n(e),s()}),t("#feature").change(function(){s()}),t("#features").change(function(){s()}),t("#property").change(function(){s()}),t("#properties").change(function(){s()}),t("#time_range").dateRangePicker({separator:" to ",language:"en",startOfWeek:"monday",format:"YYYY-MM-DD[T]HH:mm:ssZ",endDate:moment.utc(),autoClose:!0,showShortcuts:!1,shortcuts:null,time:{enabled:!0},getValue:function(){return t("#time_start").val()&&t("#time_end").val()?t("#time_start").val()+" to "+t("#time_end").val():""},setValue:function(e,r,a){t("#time_start").val(moment(r).utc().format()),t("#time_end").val(moment(a).utc().format())}})}function a(e){if(e&&t("#service")){t("#service").append(t("<option>").append("Select a Service..."));for(var r in e)url=e[r],t("#service").append(t("<option>").attr("id",url).append(url))}}function i(r){p("#offering","#property","#properties","#feature","#features"),featureNames={},propertyNames={},r&&(t("#offering").append(t("<option>").append("Select an Offering...")),e.setUrl(r),e.getCapabilities(function(e){for(var r in e){var a=e[r];t("#offering").append(t("<option>").attr("id",a.identifier).data("procedure",a.procedure[0]).append(a.name))}}))}function n(r){p("#property","#properties"),propertyNames={},r&&e.describeSensor(r,function(e){var r=e.hasOwnProperty("ProcessModel")?e.ProcessModel.outputs.OutputList.output:e.System.outputs.OutputList.output;r=r instanceof Array?r:[r];for(var a in r){var i=r[a],n=["Quantity","Count","Boolean","Category","Text","ObservableProperty"];for(var o in n){var s=n[o];i.hasOwnProperty(s)&&(i.type=s,i.id=i[s].definition,i.description=i.name+" ("+s,"Quantity"==s&&i[s].hasOwnProperty("uom")&&(i.description+=" ["+i[s].uom.code+"]"),i.description+=")")}propertyNames[i.id]=i.description,t("#property, #properties").append(t("<option>").attr("id",i.id).append(i.description))}})}function o(r){p("#feature","#features"),featureNames={},r&&e.getFeatureOfInterest(r,function(e){for(var r in e){var a=e[r],i=a.identifier.value,n=a.name.value;featureNames[i]=n,t("#feature, #features").append(t("<option>").attr("id",i).append(n))}})}function s(){var r=t("#offering option:selected").data("procedure"),a=t("#feature option:selected").attr("id"),i=t("#property option:selected").attr("id"),n=a?a:t("#features option:selected").map(function(){return this.id}).get(),o=i?i:t("#properties option:selected").map(function(){return this.id}).get();e.getDataAvailability(r,n,o,function(e){for(var r=e[0].phenomenonTime[0],a=e[0].phenomenonTime[1],i=1;i<e.length;i++){var n=e[i].phenomenonTime[0],o=e[i].phenomenonTime[1];r>n&&(r=n),o>a&&(a=o)}t("#time_start").val(moment(r).utc().format()),t("#time_end").val(moment(a).utc().format())})}function p(){for(var e=0;e<arguments.length;e++)t(arguments[e])&&t(arguments[e]).find("option").remove();t("#time_start").val(""),t("#time_end").val("")}function u(){var e=t('[name="build"]').data(),r=[];r.push("name="+e.name);var a=function(){return this.id};for(var i in e.inputs){var n,o=e.inputs[i];switch(o){case"service":case"offering":case"feature":case"property":n=t("#"+o+" option:selected").attr("id");break;case"features":case"properties":n=t("#"+o+" option:selected").map(a).get(),n=JSON.stringify(n);break;default:n=t("#"+o).val()}n&&r.push(o+"="+encodeURIComponent(n))}var s="?"+r.join("&"),p='<iframe id="iframe" src="'+s+'" width="100%" height="100%" frameBorder="0"><p>Your browser does not support iframes.</p></iframe>';t("#widget").resizable("destroy"),t("#widget").html(p),t("#widget").resizable({helper:"ui-resizable-helper"})}function c(e){return e.toLowerCase().replace("_"," ").replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()})}var d=["name"];return{inputs:d,init:function(e,t){require(["widget/"+e.name],function(a){r(a,e,t)},function(){console.error("Widget '"+e.name+"' cannot be found.")})}}});